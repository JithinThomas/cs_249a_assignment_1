#include "gtest/gtest.h"
#include "fwk/fwk.h"
#include "MalwareStrength.h"
#include "Port.h"
#include "Device.h"
#include "System.h"

TEST(Device, defaultHealth) {
    const auto device = PersonalDevice::instanceNew("device-1");
    ASSERT_TRUE(device->health() == "healthy");
}

TEST(Device, healthIs) {
    const auto device = PersonalDevice::instanceNew("device-1");
    device->healthIs("infected");
    ASSERT_TRUE(device->health() == "infected");
}

// ============================================================
//  Public methods of System class
// ============================================================
TEST(Network, networkNew) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto n = sys->network(networkName);
	ASSERT_TRUE(n == null);

	sys->networkNew(networkName);
	n = sys->network(networkName);
	ASSERT_TRUE(n != null);
	ASSERT_TRUE(n->name() == networkName);
}

TEST(Network, personalNew) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto deviceName = "personal-1-1";
	auto network = sys->networkNew(networkName);
	auto device = network->device(deviceName);
	ASSERT_TRUE(device == null);

	sys->personalNew(networkName, deviceName);
	device = network->device(deviceName);

	ASSERT_TRUE(device != null);
	ASSERT_TRUE(device->name() == deviceName);
	ASSERT_TRUE(device->health() == "healthy");
	ASSERT_TRUE(isPersonalDevice(device));
}

TEST(Network, firewallNew) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto deviceName = "firewall-1";
	auto network = sys->networkNew(networkName);
	auto device = network->device(deviceName);
	ASSERT_TRUE(device == null);

	sys->firewallNew(networkName, deviceName);
	device = network->device(deviceName);

	ASSERT_TRUE(device != null);
	ASSERT_TRUE(device->name() == deviceName);
	ASSERT_TRUE(device->health() == "healthy");
	ASSERT_TRUE(isFirewallDevice(device));
}

TEST(Device, connectionIs) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-4";
	auto device2Name = "device-7";
	auto n = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto p1 = 3;
	auto p2 = 11;

	ASSERT_TRUE(device1->availablePort(p1));
	ASSERT_TRUE(device2->availablePort(p2));

	sys->connectionIs(networkName, device1Name, p1, device2Name, p2);

	auto port1 = device1->port(p1);
	auto port2 = device2->port(p2);

	ASSERT_FALSE(device1->availablePort(p1));
	ASSERT_FALSE(device2->availablePort(p2));	
	ASSERT_TRUE(port1.otherDevice() == device2);
	ASSERT_TRUE(port1.otherPort() == p2);
	ASSERT_TRUE(port2.otherDevice() == device1);
	ASSERT_TRUE(port2.otherPort() == p1);
}

TEST(Device, clone) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-4";
	auto clone1Name = "device-4-clone";
	auto device2Name = "device-7";
	auto clone2Name = "device-7-clone";

	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto p1 = 6;
	auto p2 = 0;
	
	ASSERT_TRUE(network->device(clone1Name) == null);

	sys->clone(networkName, device1Name, p1, clone1Name, p2);
	
	auto clone1 = network->device(clone1Name);
	ASSERT_TRUE(clone1 != null);
	ASSERT_TRUE(clone1->health() == device1->health());
	ASSERT_TRUE(clone1->port(p2).otherDevice() == device1);
	ASSERT_TRUE(clone1->port(p2).otherPort() == p1);

	device2->healthIs("infected");
	device2->portRatingIs(p1, 0.8);
	sys->clone(networkName, device2Name, p1, clone2Name, p2);

	auto clone2 = network->device(clone2Name);
	ASSERT_TRUE(clone2->health() == "infected");
	for (auto i = 0; i < clone2->portCount(); i++) {
		ASSERT_TRUE(clone2->port(i).rating() == device2->port(i).rating());
	}
}

TEST(Device, ratingIs) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto deviceName = "personal-1";
	auto network = sys->networkNew(networkName);
	auto device = sys->personalNew(networkName, deviceName);
	auto p1 = 5;
	auto p2 = 1;
	ASSERT_TRUE(device->port(p1).rating() == 0);
	ASSERT_TRUE(device->port(p2).rating() == 0);

	auto newRating = 0.4;
	sys->ratingIs(networkName, deviceName, p1, newRating);

	ASSERT_TRUE(device->port(p1).rating() == newRating);
	ASSERT_TRUE(device->port(p2).rating() == 0);
}

// ============================================================

// ============================================================
// Tests for helper functions
// ============================================================

TEST(Helper, isPersonalDevice) {
	auto deviceName = "device-1";
	auto device1 = PersonalDevice::instanceNew(deviceName);
	ASSERT_TRUE(isPersonalDevice(device1));
	auto device2 = FirewallDevice::instanceNew(deviceName);
	ASSERT_FALSE(isPersonalDevice(device2));
}

TEST(Helper, isFirewallDevice) {
	auto deviceName = "device-1";
	auto device1 = FirewallDevice::instanceNew(deviceName);
	ASSERT_TRUE(isFirewallDevice(device1));
	auto device2 = PersonalDevice::instanceNew(deviceName);
	ASSERT_FALSE(isFirewallDevice(device2));
}

// ============================================================
