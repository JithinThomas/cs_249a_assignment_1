#include "gtest/gtest.h"
#include "fwk/fwk.h"
#include "MalwareStrength.h"
#include "Port.h"
#include "Device.h"
#include "System.h"


TEST(Device, defaultHealth) {
    const auto device = PersonalDevice::instanceNew("device-1");
    ASSERT_TRUE(device->health() == "healthy");
}

TEST(Device, healthIs) {
    const auto device = PersonalDevice::instanceNew("device-1");
    device->healthIs("infected");
    ASSERT_TRUE(device->health() == "infected");
}

// ============================================================
//  Public methods of System class
// ============================================================
TEST(Network, networkNew) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto n = sys->network(networkName);
	ASSERT_TRUE(n == null);

	sys->networkNew(networkName);
	n = sys->network(networkName);
	ASSERT_TRUE(n != null);
	ASSERT_TRUE(n->name() == networkName);
}

TEST(Network, personalNew) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto deviceName = "personal-1-1";
	auto network = sys->networkNew(networkName);
	auto device = network->device(deviceName);
	ASSERT_TRUE(device == null);

	auto ret = sys->personalNew(networkName, deviceName);
	device = network->device(deviceName);

	ASSERT_TRUE(device != null);
	ASSERT_TRUE(ret == device); // To ensure that the personalNew command returns the newly created device
	ASSERT_TRUE(device->name() == deviceName);
	ASSERT_TRUE(device->health() == "healthy");
	ASSERT_TRUE(isPersonalDevice(device));
}

TEST(Network, firewallNew) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto deviceName = "firewall-1";
	auto network = sys->networkNew(networkName);
	auto device = network->device(deviceName);
	ASSERT_TRUE(device == null);

	auto ret = sys->firewallNew(networkName, deviceName);
	device = network->device(deviceName);

	ASSERT_TRUE(device != null);
	ASSERT_TRUE(ret == device); // To ensure that the firewallNew command returns the newly created device
	ASSERT_TRUE(device->name() == deviceName);
	ASSERT_TRUE(device->health() == "healthy");
	ASSERT_TRUE(isFirewallDevice(device));
}

TEST(Device, connectionIs) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-4";
	auto device2Name = "device-7";
	sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	unsigned int p1 = 3;
	unsigned int p2 = 11;

	ASSERT_TRUE(device1->availablePort(p1));
	ASSERT_TRUE(device2->availablePort(p2));

	sys->connectionIs(networkName, device1Name, p1, device2Name, p2);

	auto port1 = device1->port(p1);
	auto port2 = device2->port(p2);

	ASSERT_FALSE(device1->availablePort(p1));
	ASSERT_FALSE(device2->availablePort(p2));	
	ASSERT_TRUE(port1.otherDevice() == device2);
	ASSERT_TRUE(port1.otherPort() == p2);
	ASSERT_TRUE(port2.otherDevice() == device1);
	ASSERT_TRUE(port2.otherPort() == p1);
}

TEST(Network, spreadInfection_1) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-3";
	auto device2Name = "device-9";
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);

	sys->connectionIs(networkName, device1Name, 0, device2Name, 1);

	// Attack the firewall device (device2)
	AttackTarget origin = {device2, 3, 1};
	auto stats = sys->spreadInfection(origin, MalwareStrength(0.6));
	ASSERT_TRUE(stats.attacked == 1);
	ASSERT_DOUBLE_EQ(stats.relativeStrength, -0.4);
	ASSERT_TRUE(stats.longestPath == 0);

	// Attack the personal device (device1)
	origin = {device1, 4, 1};
	stats = sys->spreadInfection(origin, MalwareStrength(0.7));
	ASSERT_TRUE(stats.attacked == 2);
 	ASSERT_DOUBLE_EQ(stats.relativeStrength, 0.4);
	ASSERT_TRUE(stats.longestPath == 1);
}

// Attack a device that's already infected
TEST(Network, spreadInfection_2) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto deviceName = "device0";
	auto network = sys->networkNew(networkName);
	auto device = sys->personalNew(networkName, deviceName);

	device->healthIs("infected");
	AttackTarget origin = {device, 3, 1};
	auto stats = sys->spreadInfection(origin, MalwareStrength(0.6));

	ASSERT_TRUE(stats.attacked == 0);
 	ASSERT_DOUBLE_EQ(stats.relativeStrength, 0);
	ASSERT_TRUE(stats.longestPath == 0);
}

// Verify that devices are attacked in breadth-first order
TEST(Network, spreadInfection_3) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-1";
	auto device2Name = "device-2";
	auto device3Name = "device-3";
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto device3 = sys->firewallNew(networkName, device3Name);

	sys->ratingIs(networkName, device1Name, 0, 0.1);
	sys->ratingIs(networkName, device1Name, 1, 0.6);
	sys->ratingIs(networkName, device2Name, 0, 0.3);
	sys->ratingIs(networkName, device2Name, 1, 0.2);
	sys->ratingIs(networkName, device3Name, 0, 0.5);
	sys->ratingIs(networkName, device3Name, 1, 0.2);

	sys->connectionIs(networkName, device1Name, 0, device2Name, 1);
	sys->connectionIs(networkName, device2Name, 0, device3Name, 1);
	sys->connectionIs(networkName, device3Name, 0, device1Name, 1);

	AttackTarget origin = {device1, 1, 1};
	auto stats = sys->spreadInfection(origin, MalwareStrength(1.0));

	// A depth-first traversal would have produced a value of (relativeStrength == 2.0) and (longestPath == 3)
	ASSERT_TRUE(stats.attacked == 3);
	ASSERT_DOUBLE_EQ(stats.relativeStrength, 1.7); 
	ASSERT_TRUE(stats.longestPath == 2);
}

TEST(Network, infectedDel) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-3";
	auto device2Name = "device-9";
	unsigned int p1 = 0;
	unsigned int p2 = 5;
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);

	sys->connectionIs(networkName, device1Name, p1, device2Name, p2);
	device2->healthIs("infected");
	sys->infectedDel(networkName);
	ASSERT_TRUE(network->device(device1Name) != null);
	ASSERT_TRUE(network->device(device1Name)->availablePort(p1));
	ASSERT_TRUE(network->device(device2Name) == null);
}

TEST(Device, clone) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-4";
	auto clone1Name = "device-4-clone";
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	unsigned int p1 = 6;
	unsigned int p2 = 0;
	
	ASSERT_TRUE(network->device(clone1Name) == null);

	// Test the clone method on a PersonalDevice
	device1->healthIs("infected");
	device1->portRatingIs(p1, 0.8);
	sys->clone(networkName, device1Name, p1, clone1Name, p2);
	auto clone1 = network->device(clone1Name);

	ASSERT_TRUE(clone1 != null);
	ASSERT_TRUE(isPersonalDevice(clone1));
	ASSERT_TRUE(clone1->health() == "infected");
	ASSERT_TRUE(clone1->port(p2).otherDevice() == device1);
	ASSERT_TRUE(clone1->port(p2).otherPort() == p1);
	for (unsigned int i = 0; i < clone1->portCount(); i++) { // verify that the ratings of all ports have been copied correctly
		ASSERT_TRUE(clone1->port(i).rating() == device1->port(i).rating());
	}
	
	// Test the clone method on a FirewallDevice
	auto device2Name = "device-7";
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto clone2Name = "device-7-clone";
	sys->clone(networkName, device2Name, p1, clone2Name, p2);
	auto clone2 = network->device(clone2Name);

	ASSERT_TRUE(isFirewallDevice(clone2));
}

TEST(Network, cloneAll_1) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-a";
	auto device2Name = "device-b";
	auto clone1Name = "device-a-4";
	auto clone2Name = "device-b-4";
	unsigned int p1 = 2;
	unsigned int p2 = 3;
	unsigned int p3 = 4;
	unsigned int p4 = 5;

	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);	
	auto device2 = sys->personalNew(networkName, device2Name);
	sys->connectionIs(networkName, device1Name, p1, device2Name, p2);
	sys->cloneAll(networkName, p3, p4);

	auto clone1 = network->device(clone1Name);
	auto clone2 = network->device(clone2Name);

	// Check original device connections
	ASSERT_TRUE(device1->port(p1).otherDevice() == device2);
	ASSERT_TRUE(device1->port(p1).otherPort() == p2);

	// Check connections between cloned devices and their parent devices
	ASSERT_TRUE(clone1->port(p4).otherDevice() == device1);
	ASSERT_TRUE(clone1->port(p4).otherPort() == p3);
	ASSERT_TRUE(clone1->port(p1).otherDevice() == clone2);
	ASSERT_TRUE(clone1->port(p1).otherPort() == p2);

	// Check connections among the cloned devices
	ASSERT_TRUE(clone2->port(p4).otherDevice() == device2);
	ASSERT_TRUE(clone2->port(p4).otherPort() == p3);
	ASSERT_TRUE(clone2->port(p2).otherDevice() == clone1);
	ASSERT_TRUE(clone2->port(p2).otherPort() == p1);
}

// This is to verify that the connections between clones and their parent devices
// are given more priority than connections among clones.
TEST(Network, cloneAll_2) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-a";
	auto device2Name = "device-b";
	auto clone1Name = "device-a-3";
	auto clone2Name = "device-b-3";
	unsigned int p1 = 2;
	unsigned int p2 = 3;

	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);	
	auto device2 = sys->personalNew(networkName, device2Name);
	sys->connectionIs(networkName, device1Name, p1, device2Name, p1);
	sys->cloneAll(networkName, p2, p1);

	ASSERT_TRUE(device1->port(p1).otherDevice() == device2);
	ASSERT_TRUE(device1->port(p1).otherPort() == p1);

	auto clone1 = network->device(clone1Name);
	auto clone2 = network->device(clone2Name);

	ASSERT_TRUE(clone1->port(p1).otherDevice() == device1);
	ASSERT_TRUE(clone1->port(p1).otherPort() == p2);

	ASSERT_TRUE(clone2->port(p1).otherDevice() == device2);
	ASSERT_TRUE(clone2->port(p1).otherPort() == p2);
}

TEST(Device, ratingIs) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto deviceName = "personal-1";
	auto network = sys->networkNew(networkName);
	auto device = sys->personalNew(networkName, deviceName);
	unsigned int p1 = 5;
	unsigned int p2 = 1;
	ASSERT_TRUE(device->port(p1).rating() == 0);
	ASSERT_TRUE(device->port(p2).rating() == 0);

	auto newRating = 0.4;
	sys->ratingIs(networkName, deviceName, p1, newRating);

	ASSERT_TRUE(device->port(p1).rating() == newRating);
	ASSERT_TRUE(device->port(p2).rating() == 0);
}

// ============================================================

// ============================================================
// Tests for notifiee methods
// ============================================================

TEST(Trackers, networkTracker) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "network-1";
	auto device1Name = "personal-1";
	auto device2Name = "firewall-1";
	auto device3Name = "firewall-2";
	auto network = sys->networkNew(networkName);
	auto device = sys->personalNew(networkName, device1Name);
	device->healthIs("infected");
	sys->firewallNew(networkName, device2Name);
	sys->firewallNew(networkName, device3Name);
	sys->cloneAll(networkName, 2, 5);

    auto networkTracker = sys->networkTracker(networkName);

    ASSERT_TRUE(networkTracker->personalDeviceCount() == 2);
    ASSERT_TRUE(networkTracker->firewallDeviceCount() == 4);
    ASSERT_TRUE(networkTracker->infectedDeviceCount() == 2);

    network->deviceDel(device2Name);
    ASSERT_TRUE(networkTracker->personalDeviceCount() == 2);
    ASSERT_TRUE(networkTracker->firewallDeviceCount() == 3);

    device->healthIs("healthy");
	ASSERT_TRUE(networkTracker->infectedDeviceCount() == 1);
}

// ============================================================

// ============================================================
// Tests to stress the public methods of System class with 
// invalid args
// ============================================================

TEST(InvalidArgsTest, networkNew) {
	const auto sys = System::instanceNew("system-1");
	ASSERT_TRUE(sys->networkNew("networkNew") == null);
	ASSERT_TRUE(sys->networkNew("ab'cd") == null);
	ASSERT_TRUE(sys->networkNew("ab\"cd") == null);
	ASSERT_TRUE(sys->networkNew("network-1") != null);
	ASSERT_TRUE(sys->networkNew("network-2") != null);
	ASSERT_TRUE(sys->networkNew("network-1") == null); // A network with the same name already exists.
}

TEST(InvalidArgsTest, personalNew) {
	const auto sys = System::instanceNew("system-1");
	const auto networkName = "qwerty";
	const auto deviceName = "device-1";
	sys->networkNew(networkName);

	ASSERT_TRUE(sys->personalNew(networkName, "personalNew") == null);
	ASSERT_TRUE(sys->personalNew(networkName, "firewallNew") == null);
	ASSERT_TRUE(sys->personalNew(networkName, "rt'we") == null);
	ASSERT_TRUE(sys->personalNew(networkName, "rt\"we") == null);
	ASSERT_TRUE(sys->personalNew("fakeNetwork", deviceName) == null);	
	ASSERT_TRUE(sys->personalNew(networkName, deviceName) != null);
	ASSERT_TRUE(sys->personalNew(networkName, deviceName) == null); // A device with the same name already exists.
}

TEST(InvalidArgsTest, firewallNew) {
	const auto sys = System::instanceNew("system-1");
	const auto networkName = "qwerty";
	const auto deviceName = "device-1";
	sys->networkNew(networkName);

	ASSERT_TRUE(sys->firewallNew(networkName, "personalNew") == null);
	ASSERT_TRUE(sys->firewallNew(networkName, "firewallNew") == null);
	ASSERT_TRUE(sys->firewallNew(networkName, "rt'we") == null);
	ASSERT_TRUE(sys->firewallNew(networkName, "rt\"we") == null);
	ASSERT_TRUE(sys->firewallNew("fakeNetwork", deviceName) == null);	
	ASSERT_TRUE(sys->firewallNew(networkName, deviceName) != null);
	ASSERT_TRUE(sys->firewallNew(networkName, deviceName) == null); // A device with the same name already exists.
}

TEST(InvalidArgsTest, connectionIs) {
	const auto sys = System::instanceNew("system-1");
	const auto networkName = "network-4";
	const auto device1Name = "device-1";
	const auto device2Name = "device-2";
	const auto device3Name = "device-3";
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto device3 = sys->firewallNew(networkName, device3Name);

	// Ports from the same device cannot be connected to each other
	//auto res = sys->connectionIs(networkName, device1Name, 3, device1Name, 0);
	ASSERT_FALSE(sys->connectionIs(networkName, device1Name, 3, device1Name, 0));
	ASSERT_TRUE(device1->availablePort(3));
	ASSERT_TRUE(device1->availablePort(0));

	// Command should fail if source port is already in use
	sys->connectionIs(networkName, device1Name, 1, device2Name, 4);
	ASSERT_FALSE(sys->connectionIs(networkName, device1Name, 1, device3Name, 2));
	ASSERT_TRUE(device1->port(1).otherDevice() == device2);
	ASSERT_TRUE(device1->port(1).otherPort() == 4);
	ASSERT_TRUE(device3->availablePort(2));

	// Command should fail if destination port is already in use
	ASSERT_FALSE(sys->connectionIs(networkName, device3Name, 5, device2Name, 4));
	ASSERT_TRUE(device2->port(4).otherDevice() == device1);
	ASSERT_TRUE(device2->port(4).otherPort() == 1);
	ASSERT_TRUE(device3->availablePort(5));

	// Command should fail if either the source or destination ports exceeds 
	// the portCount of the corresponding device
	ASSERT_FALSE(sys->connectionIs(networkName, device1Name, device1->portCount(), device2Name, 3));
	ASSERT_FALSE(sys->connectionIs(networkName, device1Name, 0, device2Name, device2->portCount() + 1));

	// Command should fail if the network or one of the devices do not exist
	ASSERT_FALSE(sys->connectionIs("fakeNetwork", device1Name, 0, device2Name, 4));
	ASSERT_FALSE(sys->connectionIs(networkName, device1Name, 0, "fakeDevice", 4));
	ASSERT_FALSE(sys->connectionIs(networkName, "fakeDevice", 0, device1Name, 4));
}

TEST(InvalidArgsTest, infectedDel) {
	const auto sys = System::instanceNew("system-1");
	ASSERT_FALSE( sys->infectedDel("fakeNetwork") );
}

TEST(InvalidArgsTest, clone) {
	const auto sys = System::instanceNew("system-1");
	const auto networkName = "network-4";
	const auto device1Name = "device-1";
	const auto device2Name = "device-2";
	const auto device3Name = "device-3";
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto device3 = sys->firewallNew(networkName, device3Name);

	// Command shoud fail is the port of the original device is already in use
	sys->connectionIs(networkName, device1Name, 5, device2Name, 0);
	ASSERT_FALSE(sys->clone(networkName, device1Name, 5, "clone", 0));
	ASSERT_TRUE(device1->port(5).otherDevice() == device2);
	ASSERT_TRUE(device1->port(5).otherPort() == 0);

	// Command should fail if the network already has a device with the same name as the clone
	ASSERT_FALSE(sys->clone(networkName, device2Name, 1, device3Name, 2));

	// Command should fail if the either one or both of the ports exceed the port count of the device
	ASSERT_FALSE(sys->clone(networkName, device1Name, device1->portCount(), "clone", 6));	
	ASSERT_FALSE(sys->clone(networkName, device1Name, 6, "clone", device1->portCount()));

	// Command should fail if the network or one of the devices do not exist
	ASSERT_FALSE(sys->clone("fakeNetwork", device1Name, 0, device2Name, 4));
	ASSERT_FALSE(sys->clone(networkName, "fakeDevice", 0, device1Name, 4));
}

TEST(InvalidArgsTest, cloneAll) {
	const auto sys = System::instanceNew("system-1");
	ASSERT_FALSE( sys->cloneAll("fakeNetwork", 4, 11) );
}

TEST(InvalidArgsTest, ratingIs) {
	const auto sys = System::instanceNew("system-1");
	ASSERT_FALSE( sys->ratingIs("fakeNetwork", "fakeDevice", 2, 0.2) );

	const auto networkName = "network-13";
	auto network = sys->networkNew(networkName);
	ASSERT_TRUE( network != null );
	ASSERT_FALSE( (sys->ratingIs(networkName, "fakeDevice", 4, 0.76)) );

	auto device = sys->personalNew(networkName, "device-1");
	ASSERT_FALSE( (sys->ratingIs(networkName, "device-1", device->portCount(), 0.43)) );
}

// ============================================================

// ============================================================
// Tests for helper functions
// ============================================================

TEST(Helper, computeOriginOfAttack) {
	const auto sys = System::instanceNew("system-1");
	auto networkName = "abcd";
	auto device1Name = "device-1";
	auto device2Name = "device-2";
	auto device3Name = "device-3";
	auto device4Name = "device-4";
	auto network = sys->networkNew(networkName);
	auto device1 = sys->personalNew(networkName, device1Name);
	auto device2 = sys->firewallNew(networkName, device2Name);
	auto device3 = sys->firewallNew(networkName, device3Name);
	auto device4 = sys->firewallNew(networkName, device4Name);

	sys->connectionIs(networkName, device1Name, 0, device2Name, 1);
	sys->connectionIs(networkName, device2Name, 2, device3Name, 3);
	sys->connectionIs(networkName, device3Name, 4, device4Name, 5);

	vector<U32> ports;
	ports.push_back(0);
	ports.push_back(2);
	ports.push_back(4);
	ports.push_back(6);
	
	auto origin = sys->computeOriginOfAttack(device1, ports);

	ASSERT_TRUE(origin.device == device4);
	ASSERT_TRUE(origin.port == 6);
	ASSERT_TRUE(origin.numHopsFromOriginOfAttack == 1);
}

TEST(Helper, isPersonalDevice) {
	auto deviceName = "device-1";
	auto device1 = PersonalDevice::instanceNew(deviceName);
	ASSERT_TRUE(isPersonalDevice(device1));
	auto device2 = FirewallDevice::instanceNew(deviceName);
	ASSERT_FALSE(isPersonalDevice(device2));
}

TEST(Helper, isFirewallDevice) {
	auto deviceName = "device-1";
	auto device1 = FirewallDevice::instanceNew(deviceName);
	ASSERT_TRUE(isFirewallDevice(device1));
	auto device2 = PersonalDevice::instanceNew(deviceName);
	ASSERT_FALSE(isFirewallDevice(device2));
}

// ============================================================
